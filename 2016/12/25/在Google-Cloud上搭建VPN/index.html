<!DOCTYPE html><html><head><meta charset="utf-8"><title>在Google Cloud上搭建VPN | Andimeo&#39;s Blog</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="之前在Google Cloud上申请过一个VPS，在Free trial期间使用了一个月，后来就关掉了。当时发现自己搭建VPN好容易啊。 直到这次，想重新激活上次那个instance来做VPN的时候，VPN已链接，但是data plane的traffic却始终发送不出去。 于是重新搜索了教程，才搞定这件事情。这里主要针对Google Cloud总结一下一些重要步骤。 关于StrongSwan的配置"><meta property="og:type" content="article"><meta property="og:title" content="在Google Cloud上搭建VPN"><meta property="og:url" content="http://andimeo.us.kg/2016/12/25/%E5%9C%A8Google-Cloud%E4%B8%8A%E6%90%AD%E5%BB%BAVPN/index.html"><meta property="og:site_name" content="Andimeo&#39;s Blog"><meta property="og:description" content="之前在Google Cloud上申请过一个VPS，在Free trial期间使用了一个月，后来就关掉了。当时发现自己搭建VPN好容易啊。 直到这次，想重新激活上次那个instance来做VPN的时候，VPN已链接，但是data plane的traffic却始终发送不出去。 于是重新搜索了教程，才搞定这件事情。这里主要针对Google Cloud总结一下一些重要步骤。 关于StrongSwan的配置"><meta property="og:locale"><meta property="article:published_time" content="2016-12-25T07:34:20.000Z"><meta property="article:modified_time" content="2024-09-07T07:25:33.406Z"><meta property="article:author" content="Andimeo"><meta property="article:tag" content="VPN"><meta property="article:tag" content="Google Cloud"><meta property="article:tag" content="IPsec"><meta property="article:tag" content="StrongSwan"><meta name="twitter:card" content="summary"><link rel="alternative" href="/atom.xml" title="Andimeo&#39;s Blog" type="application/atom+xml"><link rel="icon" href="/favicon.ico"><link href="http://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/style.css"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><meta name="generator" content="Hexo 7.3.0"></head><body><div id="container"><div id="wrap"><nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation"><div class="container"><button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Andimeo&#39;s Blog</a><div class="collapse navbar-collapse nav-menu"><ul class="nav navbar-nav"><li><a href="/archives"><i class="fa fa-archive"></i> Archives</a></li><li><a href="/categories"><i class="fa fa-folder"></i> Categories</a></li><li><a href="/tags"><i class="fa fa-tags"></i> Tags</a></li><li><a href="/about"><i class="fa fa-user"></i> About</a></li></ul><ul class="nav navbar-nav navbar-right"><li><a id="rss-link" href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li></ul></div></div></nav><div class="clearfix"></div><div id="content" class="container"><div class="page-header-wrapper"><!--[if lt IE 9]><div class="alert alert-warning alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>提示:</strong>您的浏览器版本太低了,建议升级到 <strong><a target="_blank" rel="noopener" href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" title="IE9">IE9</a></strong> 以上,本站使用<a target="_blank" rel="noopener" href="https://www.google.com/intl/zh-CN/chrome/">Chrome浏览器</a>可以获得最好的显示效果.</div><![endif]--><div class="page-header"><h1 class="title">在Google Cloud上搭建VPN</h1></div></div><section id="main"><article id="post-cm0s3y3el0012mgy7dbld2tgt" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-inner"><div class="article-entry" itemprop="articleBody"><div id="toc"><span class="toc-header">Contents</span><ol class="article-toc"><li class="article-toc-item article-toc-level-1"><a class="article-toc-link" href="#google-cloud%E9%85%8D%E7%BD%AE"><span class="article-toc-text">Google Cloud配置</span></a></li><li class="article-toc-item article-toc-level-1"><a class="article-toc-link" href="#%E5%AE%89%E8%A3%85strongswan"><span class="article-toc-text">安装StrongSwan</span></a><ol class="article-toc-child"><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="article-toc-text">准备工作</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E4%B8%8B%E8%BD%BDstrongswan%E7%9A%84%E6%BA%90%E7%A0%81%E5%B9%B6%E7%BC%96%E8%AF%91"><span class="article-toc-text">下载StrongSwan的源码并编译</span></a></li></ol></li><li class="article-toc-item article-toc-level-1"><a class="article-toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="article-toc-text">生成证书</span></a><ol class="article-toc-child"><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E7%94%9F%E6%88%90ca%E7%A7%81%E9%92%A5"><span class="article-toc-text">生成CA私钥</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E5%88%A9%E7%94%A8%E7%A7%81%E9%92%A5%E7%AD%BE%E5%90%8Dca%E8%AF%81%E4%B9%A6"><span class="article-toc-text">利用私钥签名CA证书</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E7%94%9F%E6%88%90server%E7%AB%AF%E7%A7%81%E9%92%A5"><span class="article-toc-text">生成server端私钥</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E7%94%A8ca%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%8F%91server%E7%AB%AF%E8%AF%81%E4%B9%A6"><span class="article-toc-text">用CA证书签发server端证书</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E7%94%9F%E6%88%90client%E7%AB%AF%E7%A7%81%E9%92%A5"><span class="article-toc-text">生成client端私钥</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E5%88%A9%E7%94%A8ca%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%8F%91client%E7%AB%AF%E8%AF%81%E4%B9%A6"><span class="article-toc-text">利用CA证书签发client端证书</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E7%94%9F%E6%88%90client%E7%AB%AFp12%E8%AF%81%E4%B9%A6"><span class="article-toc-text">生成client端p12证书</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E5%AE%89%E8%A3%85%E8%AF%81%E4%B9%A6"><span class="article-toc-text">安装证书</span></a></li></ol></li><li class="article-toc-item article-toc-level-1"><a class="article-toc-link" href="#%E9%85%8D%E7%BD%AEstrongswan"><span class="article-toc-text">配置StrongSwan</span></a><ol class="article-toc-child"><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E9%85%8D%E7%BD%AEipsec.conf"><span class="article-toc-text">配置ipsec.conf</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E9%85%8D%E7%BD%AEstrongswan.conf"><span class="article-toc-text">配置strongswan.conf</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E9%85%8D%E7%BD%AEipsec.secrets"><span class="article-toc-text">配置ipsec.secrets</span></a></li></ol></li><li class="article-toc-item article-toc-level-1"><a class="article-toc-link" href="#%E9%85%8D%E7%BD%AEiptables"><span class="article-toc-text">配置iptables</span></a><ol class="article-toc-child"><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E4%BF%AE%E6%94%B9sysctrl.conf"><span class="article-toc-text">修改sysctrl.conf</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E4%BF%AE%E6%94%B9iptables"><span class="article-toc-text">修改iptables</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E4%BF%9D%E5%AD%98iptables%E4%B8%94%E5%BC%80%E6%9C%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8"><span class="article-toc-text">保存iptables且开机自动启动</span></a></li><li class="article-toc-item article-toc-level-2"><a class="article-toc-link" href="#%E9%87%8D%E5%90%AFipsec%E6%9C%8D%E5%8A%A1"><span class="article-toc-text">重启ipsec服务</span></a></li></ol></li></ol></div><p>之前在Google Cloud上申请过一个VPS，在Free trial期间使用了一个月，后来就关掉了。当时发现自己搭建VPN好容易啊。 直到这次，想重新激活上次那个instance来做VPN的时候，VPN已链接，但是data plane的traffic却始终发送不出去。 于是重新搜索了教程，才搞定这件事情。这里主要针对Google Cloud总结一下一些重要步骤。</p><p>关于StrongSwan的配置部分主要参考下面这篇文章： <a target="_blank" rel="noopener" href="http://hjc.im/shi-yong-strongswanda-jian-ipsecikev2-vpn/">使用Strongswan搭建IPSec/IKEv2 VPN</a></p><h1 id="google-cloud配置">Google Cloud配置</h1><p>建立好Compute Engine后，申请一个永久静态地址，然后配置SSH登录证书等内容。 这里不再赘述，Google自己的文档里已经交代的很清楚怎么做。</p><span id="more"></span><p>主要配置是在Google的Firewall rules里，这里决定了什么包可以访问到内部的instance，其后才是instance内部的iptables的配置。</p><p>这里我们建立一条新的rule，source filter填写<code>0.0.0.0/0</code>，代表任何地方发出的包，除非你只想在特定IP上访问，否则就填写这个。 然后在Allowed protocols and ports里添加<code>udp:500;udp:4500;esp</code>。</p><ul><li>这里<code>udp:500</code>是<code>IKE</code>协议指定的端口，会通过这个端口来发送Control plane的包</li><li><code>udp:4500</code>是当source或者destination在<code>NAT</code>后时转而使用的端口，另外当<code>NAT</code>被检测到后，Data plane的数据包也会被使用端口，这个时候<code>ESP</code>的数据包会被包含在<code>UDP</code>包中，端口也是这个</li><li>最后<code>esp</code>就是允许Data plane的数据包通过</li></ul><p>另外需要勾选允许<code>ip forwarding</code>。</p><p>至此Google Cloud的配置就完成了。</p><h1 id="安装strongswan">安装StrongSwan</h1><p>这里假设使用的是Ubuntu作为操作系统，其他OS请参考相应教程。</p><h2 id="准备工作">准备工作</h2><p>安装PAM库和SSL库，以及make和gcc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install libpam0g-dev libssl-dev make gcc</span><br></pre></td></tr></table></figure><h2 id="下载strongswan的源码并编译">下载StrongSwan的源码并编译</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#下载</span><br><span class="line">wget http://download.strongswan.org/strongswan.tar.gz</span><br><span class="line">tar xzf strongswan.tar.gz</span><br><span class="line">cd strongswan-*</span><br><span class="line"></span><br><span class="line">#编译</span><br><span class="line">./configure  --enable-eap-identity --enable-eap-md5 \</span><br><span class="line">--enable-eap-mschapv2 --enable-eap-tls --enable-eap-ttls --enable-eap-peap  \</span><br><span class="line">--enable-eap-tnc --enable-eap-dynamic --enable-eap-radius --enable-xauth-eap  \</span><br><span class="line">--enable-xauth-pam  --enable-dhcp  --enable-openssl  --enable-addrblock --enable-unity  \</span><br><span class="line">--enable-certexpire --enable-radattr --enable-tools --enable-openssl --disable-gmp --enable-kernel-libipsec</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">#安装</span><br><span class="line">make install # if not root please prepend sudo</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>完成后执行<code>ipsec version</code>查看是否安装成功。</p><h1 id="生成证书">生成证书</h1><h2 id="生成ca私钥">生成CA私钥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipsec pki --gen --outform pem &gt; ca.pem  </span><br></pre></td></tr></table></figure><h2 id="利用私钥签名ca证书">利用私钥签名CA证书</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipsec pki --self --in ca.pem --dn &quot;C=com, O=myvpn, CN=VPN CA&quot; --ca --outform pem &gt;ca.cert.pem</span><br></pre></td></tr></table></figure><h2 id="生成server端私钥">生成server端私钥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipsec pki --gen --outform pem &gt; server.pem</span><br></pre></td></tr></table></figure><h2 id="用ca证书签发server端证书">用CA证书签发server端证书</h2><p>这里需要将下面的地址更换为我们刚才申请到的永久IP地址。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SERVER_ADDR=&quot;[REPLACE_WITH_YOUR_OWN_IP_ADDRESS]&quot;</span><br><span class="line">ipsec pki --pub --in server.pem | ipsec pki --issue --cacert ca.cert.pem \</span><br><span class="line">--cakey ca.pem --dn &quot;C=com, O=myvpn, CN=$SERVER_ADDR&quot; \</span><br><span class="line">--san=&quot;$SERVER_ADDR&quot; --flag serverAuth --flag ikeIntermediate \</span><br><span class="line">--outform pem &gt; server.cert.pem</span><br></pre></td></tr></table></figure><h2 id="生成client端私钥">生成client端私钥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipsec pki --gen --outform pem &gt; client.pem</span><br></pre></td></tr></table></figure><h2 id="利用ca证书签发client端证书">利用CA证书签发client端证书</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipsec pki --pub --in client.pem | ipsec pki --issue --cacert ca.cert.pem --cakey ca.pem --dn &quot;C=com, O=myvpn, CN=VPN Client&quot; --outform pem &gt; client.cert.pem</span><br></pre></td></tr></table></figure><h2 id="生成client端p12证书">生成client端p12证书</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -export -inkey client.pem -in client.cert.pem -name &quot;client&quot; -certfile ca.cert.pem -caname &quot;VPN CA&quot;  -out client.cert.p12</span><br></pre></td></tr></table></figure><h2 id="安装证书">安装证书</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># if not root probably you need to prepend sudo in front of the following commands</span><br><span class="line">cp -r ca.cert.pem /usr/local/etc/ipsec.d/cacerts/</span><br><span class="line">cp -r server.cert.pem /usr/local/etc/ipsec.d/certs/</span><br><span class="line">cp -r server.pem /usr/local/etc/ipsec.d/private/</span><br><span class="line">cp -r client.cert.pem /usr/local/etc/ipsec.d/certs/</span><br><span class="line">cp -r client.pem  /usr/local/etc/ipsec.d/private/</span><br></pre></td></tr></table></figure><h1 id="配置strongswan">配置StrongSwan</h1><h2 id="配置ipsec.conf">配置ipsec.conf</h2><p>将<code>/usr/local/etc/ipsec.conf</code>替换为如下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">config setup</span><br><span class="line">    uniqueids=never</span><br><span class="line"></span><br><span class="line">conn iOS_cert</span><br><span class="line">    keyexchange=ikev1</span><br><span class="line">    # strongswan version &gt;= 5.0.2, compatible with iOS 6.0,6.0.1</span><br><span class="line">    fragmentation=yes</span><br><span class="line">    left=%defaultroute</span><br><span class="line">    leftauth=pubkey</span><br><span class="line">    leftsubnet=0.0.0.0/0</span><br><span class="line">    leftcert=server.cert.pem</span><br><span class="line">    right=%any</span><br><span class="line">    rightauth=pubkey</span><br><span class="line">    rightauth2=xauth</span><br><span class="line">    rightsourceip=10.31.2.0/24</span><br><span class="line">    rightcert=client.cert.pem</span><br><span class="line">    auto=add</span><br><span class="line"></span><br><span class="line">conn android_xauth_psk</span><br><span class="line">    keyexchange=ikev1</span><br><span class="line">    left=%defaultroute</span><br><span class="line">    leftauth=psk</span><br><span class="line">    leftsubnet=0.0.0.0/0</span><br><span class="line">    right=%any</span><br><span class="line">    rightauth=psk</span><br><span class="line">    rightauth2=xauth</span><br><span class="line">    rightsourceip=10.31.2.0/24</span><br><span class="line">    auto=add</span><br><span class="line"></span><br><span class="line">conn networkmanager-strongswan</span><br><span class="line">    keyexchange=ikev2</span><br><span class="line">    left=%defaultroute</span><br><span class="line">    leftauth=pubkey</span><br><span class="line">    leftsubnet=0.0.0.0/0</span><br><span class="line">    leftcert=server.cert.pem</span><br><span class="line">    right=%any</span><br><span class="line">    rightauth=pubkey</span><br><span class="line">    rightsourceip=10.31.2.0/24</span><br><span class="line">    rightcert=client.cert.pem</span><br><span class="line">    auto=add</span><br><span class="line"></span><br><span class="line">conn windows7</span><br><span class="line">    keyexchange=ikev2</span><br><span class="line">    ike=aes256-sha1-modp1024!</span><br><span class="line">    rekey=no</span><br><span class="line">    left=%defaultroute</span><br><span class="line">    leftauth=pubkey</span><br><span class="line">    leftsubnet=0.0.0.0/0</span><br><span class="line">    leftcert=server.cert.pem</span><br><span class="line">    right=%any</span><br><span class="line">    rightauth=eap-mschapv2</span><br><span class="line">    rightsourceip=10.31.2.0/24</span><br><span class="line">    rightsendcert=never</span><br><span class="line">    eap_identity=%any</span><br><span class="line">    auto=add</span><br></pre></td></tr></table></figure><h2 id="配置strongswan.conf">配置strongswan.conf</h2><p>将<code>/usr/local/etc/strongswan.conf</code>替换为如下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">charon &#123;</span><br><span class="line">         load_modular = yes</span><br><span class="line">         duplicheck.enable = no</span><br><span class="line">         compress = yes</span><br><span class="line">         plugins &#123;</span><br><span class="line">                 include strongswan.d/charon/*.conf</span><br><span class="line">         &#125;</span><br><span class="line">         dns1 = 8.8.8.8</span><br><span class="line">         dns2 = 8.8.4.4</span><br><span class="line">         nbns1 = 8.8.8.8</span><br><span class="line">         nbns2 = 8.8.4.4</span><br><span class="line"> &#125;</span><br><span class="line"> include strongswan.d/*.conf</span><br></pre></td></tr></table></figure><h2 id="配置ipsec.secrets">配置ipsec.secrets</h2><p>将<code>/usr/loca/etc/ipsec.secrets</code>内容替换为如下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">: RSA server.pem</span><br><span class="line">: PSK &quot;mykey&quot;</span><br><span class="line">: XAUTH &quot;mykey&quot;</span><br><span class="line">[用户名] %any : EAP &quot;[密码]&quot;</span><br></pre></td></tr></table></figure><p>注意将PSK、XAUTH处的&quot;mykey&quot;编辑为唯一且私密的字符串，并且将[用户名]改为自己想要的登录名，[密码]改为自己想要的密码（[]符号去掉），可以添加多行，得到多个用户。</p><h1 id="配置iptables">配置iptables</h1><h2 id="修改sysctrl.conf">修改sysctrl.conf</h2><p>打开<code>/etc/sysctl.conf</code>，然后uncomment包含<code>net.ipv4.ip_forward=1</code>的这一行。</p><p>保存后，执行<code>sysctl -p</code>。</p><h2 id="修改iptables">修改iptables</h2><p>将<code>INF</code>替换为自己的网络接口.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">INF=&quot;Your own network interface&quot;</span><br><span class="line">iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A FORWARD -s 10.31.0.0/24  -j ACCEPT</span><br><span class="line">iptables -A FORWARD -s 10.31.1.0/24  -j ACCEPT</span><br><span class="line">iptables -A FORWARD -s 10.31.2.0/24  -j ACCEPT</span><br><span class="line">iptables -A INPUT -i $INF -p esp -j ACCEPT</span><br><span class="line">iptables -A INPUT -i $INF -p udp --dport 500 -j ACCEPT</span><br><span class="line">iptables -A INPUT -i $INF -p tcp --dport 500 -j ACCEPT</span><br><span class="line">iptables -A INPUT -i $INF -p udp --dport 4500 -j ACCEPT</span><br><span class="line"># for l2tp</span><br><span class="line">iptables -A INPUT -i $INF -p udp --dport 1701 -j ACCEPT</span><br><span class="line"># for pptp</span><br><span class="line">iptables -A INPUT -i $INF -p tcp --dport 1723 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -j REJECT</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.31.2.0/24 -o $INF -j MASQUERADE</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.31.2.1/24 -o $INF -j MASQUERADE</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.31.2.2/24 -o $INF -j MASQUERADE</span><br></pre></td></tr></table></figure><h2 id="保存iptables且开机自动启动">保存iptables且开机自动启动</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables-save &gt; /etc/iptables.rules</span><br><span class="line">cat &gt; /etc/network/if-up.d/iptables&lt;&lt;EOF</span><br><span class="line">#!/bin/sh</span><br><span class="line">iptables-restore &lt; /etc/iptables.rules</span><br><span class="line">EOF</span><br><span class="line">chmod +x /etc/network/if-up.d/iptables</span><br></pre></td></tr></table></figure><h2 id="重启ipsec服务">重启ipsec服务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipsec restart</span><br></pre></td></tr></table></figure><p>至此大功告成。</p><p>WP8.1手机安装<code>ca.cert.pem</code>，进入设置<code>VPN</code>添加<code>IKEv2</code>连接，地址为证书中的地址或IP，通过用户名-密码连接。 Windows连接也是一样，但注意将证书导入本地计算机而不是当前用户的“受信任的证书颁发机构”。 iOS/Android/Mac OS X设备添加<code>Cisco IPSec PSK</code>验证方式，预共享密钥是<code>/usr/local/etc/ipsec.secrets</code>中PSK后的字符串（不含引号），用户名密码同上，可以通过任意域名或IP连接，不需要证书.</p><p>接下来有时间我会试图把整个安装过程配置为一个Docker Build file，这样以后配置新的instance就跟方便了。</p></div></div></article><section id="comments"><div id="disqus_thread"></div><script>var disqus_config=function(){this.page.url="http://andimeo.us.kg/2016/12/25/%E5%9C%A8Google-Cloud%E4%B8%8A%E6%90%AD%E5%BB%BAVPN/",this.page.identifier="8c507bd8-6ba7-11ef-80cf-1747159a1056"};!function(){var e=document,t=e.createElement("script");t.src="https://andimeo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></section><aside id="sidebar"><div class="widget-wrap center"><ul class="pagination"><li><a href="/2016/12/25/2016-AMA/" class="nav-prev">Prev</a></li><li><a data-url="http://andimeo.us.kg/2016/12/25/%E5%9C%A8Google-Cloud%E4%B8%8A%E6%90%AD%E5%BB%BAVPN/" data-id="cm0s3y3el0012mgy7dbld2tgt" data_title="在Google Cloud上搭建VPN" data_summary="之前在Google Cloud上申请过一个VPS，在Free trial期间使用了一个月，后来就关掉了。当时发现自己搭建VPN好容易啊。
直到这次，想重新激活上次那个instance来做VPN的时候，..." class="article-share-link">Share</a></li><li><a href="/2016/09/04/美国之行/" class="nav-next">Next</a></li></ul></div><div class="widget-wrap"><div class="post-widget"><i class="fa fa-clock-o"></i> <time datetime="2016-12-25T07:34:20.000Z" itemprop="datePublished">2016-12-25</time></div></div><div class="widget-wrap"><div class="post-widget"><i class="fa fa-folder"></i> <a class="category-link" href="/categories/VPS/">VPS<span class="category-count">1</span></a></div></div><div class="widget-wrap"><div class="post-widget"><i class="fa fa-tags"></i> <a class="tag-none-link" href="/tags/Google-Cloud/" rel="tag">Google Cloud<span class="tag-none-count">1</span></a><a class="tag-none-link" href="/tags/IPsec/" rel="tag">IPsec<span class="tag-none-count">1</span></a><a class="tag-none-link" href="/tags/StrongSwan/" rel="tag">StrongSwan<span class="tag-none-count">1</span></a><a class="tag-none-link" href="/tags/VPN/" rel="tag">VPN<span class="tag-none-count">1</span></a></div></div></aside></div><footer id="footer"><div class="outer container"><div id="footer-info" class="inner"><a href="/">Andimeo&#39;s Blog</a> &copy; 2024 Powered by <a href="http://zespia.tw/hexo/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/Andimeo/hexo-theme-nut" target="_blank">Nut</a></div></div></footer><a id="gotop" href="#"><i class="fa fa-chevron-up"></i></a></div><nav id="mobile-nav"><a href="[object Object]" class="mobile-nav-link">0</a> <a href="[object Object]" class="mobile-nav-link">1</a> <a href="[object Object]" class="mobile-nav-link">2</a> <a href="[object Object]" class="mobile-nav-link">3</a></nav><script src="/js/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/js/jquery.fitvids.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/script.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ 
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]} 
});</script><script type="text/javascript" src="/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script id="dsq-count-scr" src="//andimeo.disqus.com/count.js" async></script></div></body></html>